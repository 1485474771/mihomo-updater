name: Docker Image CI to GHCR

# å®šä¹‰è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  push:
    branches: [ "main" ] # ä»…åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è¿è¡Œ

# å®šä¹‰æƒé™ï¼Œå¿…é¡»åŒ…å« packages: write æ‰èƒ½æ¨é€é•œåƒåˆ° GHCR
permissions:
  contents: read
  packages: write

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up QEMU (ç”¨äºè·¨å¹³å°æ„å»º)
        uses: docker/setup-qemu-action@v3
      
      - name: ğŸ› ï¸ Set up Docker Buildx (ç”¨äºå¢å¼ºæ„å»ºåŠŸèƒ½)
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # ä½¿ç”¨å†…ç½®çš„ ${{ github.actor }} ä½œä¸ºç”¨æˆ·å
          username: ${{ github.actor }} 
          # ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ GITHUB_TOKEN ä½œä¸ºå¯†ç 
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract Docker metadata (æå–é•œåƒåå’Œæ ‡ç­¾)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }} # é•œåƒæ ¼å¼: ghcr.io/<owner>/<repo_name>
          tags: |
            type=sha,prefix=sha-,format=long
            type=raw,value=latest,enable={{is_default_branch}} # å¦‚æœæ˜¯é»˜è®¤åˆ†æ”¯ï¼Œæ‰“ latest æ ‡ç­¾

      - name: ğŸ”¨ Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # Dockerfile æ‰€åœ¨çš„æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ (é»˜è®¤ä¸ºé¡¹ç›®æ ¹ç›®å½•)
          push: true # è®¾ä¸º true æ‰ä¼šæ¨é€åˆ°æ³¨å†Œè¡¨
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # file: ./path/to/Dockerfile # å¦‚æœ Dockerfile ä¸åœ¨æ ¹ç›®å½•ï¼Œè¯·å–æ¶ˆæ³¨é‡Šå¹¶æŒ‡å®šè·¯å¾„
          # cache-from: type=gha # å¯é€‰ï¼šä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿåç»­æ„å»º
          # cache-to: type=gha,mode=max 
